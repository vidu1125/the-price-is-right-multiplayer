# Káº¾ HOáº CH TRIá»‚N KHAI: USE CASE READY

**NgÃ y:** 2026-01-14  
**Use Case:** Player toggle ready state  
**Äá»™ Æ°u tiÃªn:** Cao (cáº§n thiáº¿t Ä‘á»ƒ start game)

---

## ğŸ“‹ **TÃ“M Táº®T**

**Má»¥c tiÃªu:** Player cÃ³ thá»ƒ toggle tráº¡ng thÃ¡i "ready" Ä‘á»ƒ bÃ¡o hiá»‡u sáºµn sÃ ng chÆ¡i game.

**Äáº·c Ä‘iá»ƒm:**
- âœ… Toggle state: `is_ready = !is_ready` (báº¥m 1 láº§n ready, báº¥m láº¡i láº§n ná»¯a unready)
- âœ… Real-time only (KHÃ”NG lÆ°u DB)
- âœ… Broadcast cho táº¥t cáº£ players trong room
- âœ… ÄÆ¡n giáº£n nháº¥t trong cÃ¡c use case

---

## ğŸ¯ **YÃŠU Cáº¦U CHá»¨C NÄ‚NG**

### **1. Giao Thá»©c (Protocol)**

**Client â†’ Server:**
```
CMD_READY (0x0203)
Payload: EMPTY (0 bytes)
```

**Server â†’ Client:**
```
NTF_PLAYER_READY (0x02C8)
Payload: JSON
{
  "account_id": 123,
  "is_ready": true
}
```

### **2. Business Logic**

```
1. Player báº¥m nÃºt "Ready" trÃªn UI
2. Frontend gá»­i CMD_READY (khÃ´ng cÃ³ payload)
3. Backend:
   - Validate session
   - TÃ¬m player trong RoomState
   - Toggle is_ready: true â†” false
   - Broadcast NTF_PLAYER_READY cho táº¥t cáº£ players
4. Frontend nháº­n notification:
   - Update UI (button color, text)
   - Hiá»ƒn thá»‹ tráº¡ng thÃ¡i ready cá»§a player
```

### **3. State Machine**

```
[Player in ROOM_WAITING]
    â†“ Click "Ready" button
    â†“ Send CMD_READY
    â†“ Server toggle is_ready
    â†“ Broadcast NTF_PLAYER_READY
    â†“ All clients update UI
```

---

## ğŸ—ï¸ **THIáº¾T Káº¾ BACKEND**

### **File 1: [room_handler.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/room_handler.c)** (NEW HANDLER)

```c
void handle_ready(int client_fd, MessageHeader *req, const char *payload) {
    printf("[HANDLER] <READY> Request from fd=%d\n", client_fd);
    
    // STEP 1: Validate session
    UserSession *session = session_get_by_socket(client_fd);
    if (!session || session->state != SESSION_LOBBY) {
        send_error(client_fd, req, ERR_NOT_LOGGED_IN, "Not logged in or not in lobby");
        return;
    }
    
    // STEP 2: Find room
    uint32_t room_id = room_find_by_player_account(session->account_id);
    if (room_id == 0) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Not in any room");
        return;
    }
    
    RoomState *room = room_get_state(room_id);
    if (!room) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Room not found");
        return;
    }
    
    // STEP 3: Find player in RoomPlayerState array
    RoomPlayerState *player = NULL;
    int player_index = -1;
    for (int i = 0; i < room->player_count; i++) {
        if (room->players[i].account_id == session->account_id) {
            player = &room->players[i];
            player_index = i;
            break;
        }
    }
    
    if (!player) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Player not found in room");
        return;
    }
    
    // STEP 4: Log BEFORE state
    printf("[Ready] BEFORE toggle:\n");
    printf("  - Player: %s (id=%u, index=%d)\n", player->name, player->account_id, player_index);
    printf("  - Current is_ready: %s\n", player->is_ready ? "true" : "false");
    
    // STEP 5: Toggle ready state in RoomPlayerState
    bool old_state = player->is_ready;
    player->is_ready = !player->is_ready;
    
    printf("[Ready] AFTER toggle:\n");
    printf("  - New is_ready: %s\n", player->is_ready ? "true" : "false");
    printf("  - Change: %s -> %s\n", 
           old_state ? "true" : "false",
           player->is_ready ? "true" : "false");
    
    // STEP 6: Log ALL players' ready status
    printf("[Ready] Current ready status of ALL players in room %u:\n", room_id);
    int ready_count = 0;
    for (int i = 0; i < room->player_count; i++) {
        printf("  [%d] %s (id=%u): %s%s\n",
               i,
               room->players[i].name,
               room->players[i].account_id,
               room->players[i].is_ready ? "âœ… READY" : "âŒ NOT READY",
               room->players[i].is_host ? " (HOST)" : "");
        if (room->players[i].is_ready) ready_count++;
    }
    printf("[Ready] Summary: %d/%d players ready\n", ready_count, room->player_count);
    
    // STEP 7: Send response (empty payload)
    forward_response(client_fd, req, RES_READY_OK, "", 0);
    
    // STEP 8: Broadcast NTF_PLAYER_READY
    cJSON *notif = cJSON_CreateObject();
    cJSON_AddNumberToObject(notif, "account_id", session->account_id);
    cJSON_AddBoolToObject(notif, "is_ready", player->is_ready);
    
    char *notif_str = cJSON_PrintUnformatted(notif);
    printf("[Ready] Broadcasting NTF_PLAYER_READY: %s\n", notif_str);
    room_broadcast(room_id, NTF_PLAYER_READY, notif_str, strlen(notif_str), -1);
    free(notif_str);
    cJSON_Delete(notif);
    
    printf("[Ready] âœ… SUCCESS: room_id=%u, account_id=%u, is_ready=%s\n",
           room_id, session->account_id, player->is_ready ? "true" : "false");
}
```

### **File 2: [dispatcher.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/dispatcher.c)** (REGISTER HANDLER)

```c
case CMD_READY:
    handle_ready(client_fd, header, payload);
    break;
```

### **File 3: [opcode.h](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/include/protocol/opcode.h)** (CHECK OPCODES)

```c
// Request
#define CMD_READY       0x0203

// Response
#define RES_READY_OK    0x00E3  // Cáº§n define náº¿u chÆ°a cÃ³

// Notification
#define NTF_PLAYER_READY 0x02C8
```

---

## ğŸ¨ **THIáº¾T Káº¾ FRONTEND**

### **File 1: [roomService.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/services/roomService.js)** (NEW SERVICE)

```javascript
// Frontend/src/services/roomService.js

import { sendPacket } from '../network/dispatcher';
import { registerHandler } from '../network/receiver';
import { OPCODE } from '../network/opcode';

/**
 * Toggle ready state
 */
export function toggleReady() {
    console.log('[ROOM_SERVICE] Toggling ready state');
    
    // Send packet with EMPTY payload
    sendPacket(OPCODE.CMD_READY, new Uint8Array(0));
}

// Register handler for RES_READY_OK
registerHandler(OPCODE.RES_READY_OK, (payload) => {
    console.log('[ROOM_SERVICE] âœ… Ready state updated');
    // UI will be updated via NTF_PLAYER_READY
});
```

### **File 2: [WaitingRoom.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/WaitingRoom.js)** (HANDLE NOTIFICATION)

```javascript
// Add to useEffect in WaitingRoom.js

// Handle NTF_PLAYER_READY
registerHandler(OPCODE.NTF_PLAYER_READY, (payload) => {
    console.log('[WaitingRoom] Player ready notification');
    const data = JSON.parse(new TextDecoder().decode(payload));
    
    setRoom(prev => ({
        ...prev,
        players: prev.players.map(p => 
            p.account_id === data.account_id
                ? { ...p, is_ready: data.is_ready }
                : p
        )
    }));
    
    console.log(`ğŸ”” Player ${data.account_id} is now ${data.is_ready ? 'READY' : 'NOT READY'}`);
});
```

### **File 3: [MemberListPanel.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/MemberListPanel.js)** (ADD READY BUTTON)

```javascript
// Update MemberListPanel.js to add READY button for each player

import { toggleReady } from '../../../services/roomService';

export default function MemberListPanel({ members, currentUserId }) {
    
    const handleReadyClick = (playerId) => {
        // Only allow current user to toggle their own ready state
        if (playerId === currentUserId) {
            toggleReady();
        }
    };
    
    return (
        <div className="member-list-panel">
            <h3>PLAYERS</h3>
            <div className="member-list">
                {members.map((member, index) => (
                    <div key={member.account_id} className="member-item">
                        <div className="member-info">
                            <span className="member-name">
                                {member.name}
                                {member.is_host && <span className="host-badge">HOST</span>}
                            </span>
                        </div>
                        
                        {/* READY BUTTON - NEW */}
                        <button
                            className={`ready-btn ${member.is_ready ? 'ready' : 'not-ready'}`}
                            onClick={() => handleReadyClick(member.account_id)}
                            disabled={member.account_id !== currentUserId}
                        >
                            {member.is_ready ? 'âœ… READY' : 'âŒ NOT READY'}
                        </button>
                    </div>
                ))}
            </div>
        </div>
    );
}
```

### **File 4: [WaitingRoom.css](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/WaitingRoom.css)** (ADD READY BUTTON STYLES)

```css
/* Ready button styles */
.ready-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 2px solid #1F2A44;
    font-family: 'Luckiest Guy', cursive;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 120px;
}

.ready-btn.ready {
    background: #8BC34A;  /* Green */
    color: white;
    box-shadow: 0 4px 0 #558b2f;
}

.ready-btn.not-ready {
    background: #FF5252;  /* Red */
    color: white;
    box-shadow: 0 4px 0 #c62828;
}

.ready-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.ready-btn:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 0 #558b2f;
}

.ready-btn:not(:disabled):active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #558b2f;
}

.host-badge {
    margin-left: 8px;
    padding: 2px 8px;
    background: #FFEB3B;
    color: #1F2A44;
    border-radius: 4px;
    font-size: 10px;
}
```

---

## âœ… **VALIDATION RULES**

| Äiá»u kiá»‡n | Xá»­ lÃ½ |
|-----------|-------|
| User khÃ´ng login | `ERR_NOT_LOGGED_IN (401)` |
| User khÃ´ng á»Ÿ trong room | `ERR_BAD_REQUEST (400)` |
| Room khÃ´ng tá»“n táº¡i | `ERR_BAD_REQUEST (400)` |
| Player khÃ´ng trong RoomState | `ERR_BAD_REQUEST (400)` |

**KhÃ´ng cáº§n validate:**
- âŒ Room status (cÃ³ thá»ƒ ready ngay cáº£ khi game Ä‘ang chÆ¡i - tÃ¹y design)
- âŒ Host/non-host (táº¥t cáº£ Ä‘á»u cÃ³ thá»ƒ ready)
- âŒ Sá»‘ lÆ°á»£ng players ready (logic start game sáº½ check)

---

## ğŸ§ª **TEST CASES**

### **TC-1: Player Toggle Ready ThÃ nh CÃ´ng**

**Precondition:**
- User A Ä‘Ã£ join vÃ o room
- `is_ready = false`

**Steps:**
1. User A click nÃºt "Ready"

**Expected:**
- âœ… Server update `player.is_ready = true`
- âœ… User A nháº­n `RES_READY_OK`
- âœ… Táº¥t cáº£ players nháº­n `NTF_PLAYER_READY`:
  ```json
  {
    "account_id": 123,
    "is_ready": true
  }
  ```
- âœ… UI button Ä‘á»•i mÃ u: red â†’ green
- âœ… UI text Ä‘á»•i: "NOT READY" â†’ "READY"

---

### **TC-2: Player Toggle Unready**

**Precondition:**
- User A Ä‘Ã£ ready (`is_ready = true`)

**Steps:**
1. User A click nÃºt "Ready" láº§n ná»¯a

**Expected:**
- âœ… Server update `player.is_ready = false`
- âœ… Broadcast `NTF_PLAYER_READY` vá»›i `is_ready: false`
- âœ… UI button Ä‘á»•i: green â†’ red
- âœ… UI text Ä‘á»•i: "READY" â†’ "NOT READY"

---

### **TC-3: Multiple Players Ready**

**Precondition:**
- Room cÃ³ 3 players: A, B, C
- Táº¥t cáº£ Ä‘á»u `is_ready = false`

**Steps:**
1. Player A ready
2. Player B ready
3. Player C ready

**Expected:**
- âœ… Má»—i láº§n ready trigger 1 broadcast
- âœ… Táº¥t cáº£ players tháº¥y tráº¡ng thÃ¡i ready cá»§a nhau
- âœ… Server logs:
  ```
  [READY] Player Alice (id=7): ready false -> true
  [READY] Player Bob (id=8): ready false -> true
  [READY] Player Charlie (id=9): ready false -> true
  ```

---

### **TC-4: Player Not In Room**

**Steps:**
1. User A (khÃ´ng á»Ÿ trong room nÃ o) gá»­i `CMD_READY`

**Expected:**
- âœ… `ERR_BAD_REQUEST (400)`
- âœ… Message: "Not in any room"

---

## âš ï¸ **EDGE CASES**

### **1. Ready State Reset Khi Rules Thay Äá»•i**

**Scenario:**
```
T=0s: Player A ready (is_ready = true)
T=1s: Host Ä‘á»•i rules
T=2s: Server reset all is_ready = false (Ä‘Ã£ implement trong SET_RULE)
T=3s: Player A pháº£i ready láº¡i
```

**Xá»­ lÃ½:** âœ… ÄÃ£ handle trong [handle_set_rule()](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/room_handler.c#730-866) (STEP 7)

---

### **2. Player Disconnect Khi Äang Ready**

**Scenario:**
```
T=0s: Player A ready (is_ready = true)
T=1s: Player A disconnect
T=2s: Player A reconnect
```

**Xá»­ lÃ½:**
- âœ… Disconnect â†’ Remove player â†’ `is_ready` state máº¥t
- âœ… Reconnect â†’ Join láº¡i room â†’ `is_ready = false` (default)
- âœ… Player pháº£i ready láº¡i

---

### **3. Host Ready vs Non-Host Ready**

**Design Decision:** Táº¥t cáº£ players (bao gá»“m host) Ä‘á»u cÃ³ thá»ƒ ready.

**LÃ½ do:**
- âœ… Host cÅ©ng lÃ  player
- âœ… Game chá»‰ start khi **Táº¤T Cáº¢** players ready (bao gá»“m host)

---

### **4. Start Game Logic (KhÃ´ng Implement Trong Use Case NÃ y)**

**Äiá»u kiá»‡n start game:**
```c
bool can_start_game(RoomState *room) {
    if (room->player_count < 4) return false;  // Tá»‘i thiá»ƒu 4 players
    
    for (int i = 0; i < room->player_count; i++) {
        if (!room->players[i].is_ready) {
            return false;  // Táº¥t cáº£ pháº£i ready
        }
    }
    
    return true;
}
```

**Note:** Logic nÃ y sáº½ implement trong use case `START_GAME`, khÃ´ng pháº£i `READY`.

---

## ğŸ“Š **SO SÃNH Vá»šI CÃC USE CASE KHÃC**

| Feature | CREATE_ROOM | SET_RULE | READY | JOIN_ROOM |
|---------|-------------|----------|-------|-----------|
| Payload size | 36 bytes | 4 bytes | **0 bytes** | 16 bytes |
| DB update | âœ… | âœ… | **âŒ** | âœ… |
| Broadcast | âœ… | âœ… | âœ… | âœ… |
| Validation | Complex | Medium | **Simple** | Medium |
| State change | Create new | Update existing | **Toggle bool** | Add player |

**READY lÃ  use case Ä‘Æ¡n giáº£n nháº¥t!**

---

## ğŸš€ **ROLLOUT PLAN**

### **Phase 1: Backend (30 phÃºt)**
1. âœ… Add `handle_ready()` to [room_handler.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/room_handler.c)
2. âœ… Register handler in [dispatcher.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/dispatcher.c)
3. âœ… Define `RES_READY_OK` in [opcode.h](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/include/protocol/opcode.h) (náº¿u chÆ°a cÃ³)
4. âœ… Test vá»›i Postman/curl

### **Phase 2: Frontend (30 phÃºt)**
1. âœ… Create [roomService.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/services/roomService.js) vá»›i `toggleReady()`
2. âœ… Add `NTF_PLAYER_READY` handler to [WaitingRoom.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/WaitingRoom.js)
3. âœ… Update [MemberListPanel.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/MemberListPanel.js) ready button

### **Phase 3: Testing (15 phÃºt)**
1. âœ… Test TC-1, TC-2, TC-3, TC-4
2. âœ… Verify broadcast to all players
3. âœ… Verify UI updates correctly

**Tá»•ng thá»i gian:** ~1.5 giá»

---

## ğŸ“ **CHECKLIST TRIá»‚N KHAI**

### **Backend:**
- [ ] Define `RES_READY_OK` opcode
- [ ] Implement `handle_ready()` in [room_handler.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/room_handler.c)
- [ ] Register in [dispatcher.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/dispatcher.c)
- [ ] Add logging vá»›i prefix `[READY]`
- [ ] Test vá»›i Postman

### **Frontend:**
- [ ] Create [roomService.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/services/roomService.js)
- [ ] Implement `toggleReady()` function
- [ ] Add `NTF_PLAYER_READY` handler
- [ ] Update [MemberListPanel.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/MemberListPanel.js) UI
- [ ] Add CSS for ready/not-ready states

### **Testing:**
- [ ] Test toggle ready/unready
- [ ] Test multiple players ready
- [ ] Test broadcast to all
- [ ] Test error cases
- [ ] Verify UI updates

---

## ğŸ¯ **SUCCESS CRITERIA**

- âœ… Player cÃ³ thá»ƒ toggle ready state
- âœ… Táº¥t cáº£ players tháº¥y tráº¡ng thÃ¡i ready cá»§a nhau real-time
- âœ… UI cáº­p nháº­t ngay láº­p tá»©c
- âœ… KhÃ´ng cÃ³ DB writes (performance tá»‘t)
- âœ… Broadcast hoáº¡t Ä‘á»™ng Ä‘Ãºng

---

## ğŸ’¡ **GHI CHÃš THIáº¾T Káº¾**

### **Táº¡i sao KHÃ”NG lÆ°u DB?**
- âœ… Ready state lÃ  **transient** (táº¡m thá»i)
- âœ… Máº¥t khi disconnect/reconnect (Ä‘Ãºng behavior)
- âœ… KhÃ´ng cáº§n persist vÃ¬ game chÆ°a báº¯t Ä‘áº§u
- âœ… Performance: Giáº£m DB writes

### **Táº¡i sao dÃ¹ng Toggle thay vÃ¬ Set?**
- âœ… UX tá»‘t hÆ¡n: 1 button cho cáº£ ready/unready
- âœ… ÄÆ¡n giáº£n hÆ¡n: KhÃ´ng cáº§n payload
- âœ… Ãt lá»—i hÆ¡n: Server tá»± toggle, khÃ´ng cáº§n client gá»­i state

### **Táº¡i sao Broadcast cho táº¥t cáº£ (bao gá»“m sender)?**
- âœ… Consistency: Táº¥t cáº£ clients tháº¥y cÃ¹ng 1 state
- âœ… ÄÆ¡n giáº£n: KhÃ´ng cáº§n logic Ä‘áº·c biá»‡t cho sender
- âœ… Reliable: Server lÃ  source of truth

---

## ğŸ“š **TÃ€I LIá»†U THAM KHáº¢O**

- [room_usecase.md](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Plan/room_usecase.md#L689-L747) - Use case specification
- [Workflow.txt](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Docs/Workflow.txt) - Architecture guidelines
- [APPLICATION DESIGN.txt](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Docs/APPLICATION%20DESIGN.txt) - Protocol specification

---

**Káº¿ hoáº¡ch nÃ y Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ review vÃ  triá»ƒn khai!**
