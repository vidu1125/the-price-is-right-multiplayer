# PLAN TRIá»‚N KHAI: SET GAME RULE USE CASE

## ğŸ“‹ TÃ“M Táº®T

**Má»¥c tiÃªu:** Host cÃ³ thá»ƒ thay Ä‘á»•i cáº¥u hÃ¬nh phÃ²ng (mode, max_players, visibility, wager_mode) trÆ°á»›c khi báº¯t Ä‘áº§u game.

**Äáº·c Ä‘iá»ƒm:**
- Chá»‰ host má»›i Ä‘Æ°á»£c phÃ©p thay Ä‘á»•i
- Rules chá»‰ commit khi host báº¥m "Done"
- Sau khi thay Ä‘á»•i â†’ Reset táº¥t cáº£ tráº¡ng thÃ¡i `is_ready` vá» `false`
- Broadcast cho táº¥t cáº£ players trong phÃ²ng

---

## ğŸ¯ YÃŠU Cáº¦U Tá»ª MÃ”N NETWORK PROGRAMMING

Dá»±a trÃªn `APPLICATION DESIGN.txt`:

### **1. Giao thá»©c (Protocol)**
- âœ… **TCP Stream Socket** - Äáº£m báº£o tin cáº­y
- âœ… **Binary Protocol** - Header 16 bytes + Payload
- âœ… **Stateful** - Server track session state
- âœ… **Request-Response + Broadcast** - Unicast response + multicast notification

### **2. Message Structure**
```c
// Header (16 bytes - Ä‘Ã£ cÃ³)
MessageHeader {
    magic: 0x4347
    version: 0x01
    command: CMD_SET_RULE (0x0206)
    length: 4 bytes (payload size)
}

// Payload (4 bytes)
SetRulePayload {
    uint8_t mode;          // 0=ELIMINATION, 1=SCORING
    uint8_t max_players;   // 4-6
    uint8_t visibility;    // 0=PUBLIC, 1=PRIVATE
    uint8_t wager_mode;    // 0=OFF, 1=ON
}
```

### **3. State Machine**
```
SESSION_LOBBY + is_host + ROOM_WAITING
    â†“ CMD_SET_RULE
    â†“ Validate
    â†“ Update RoomState
    â†“ Reset ready states
    â†“ RES_RULES_UPDATED (unicast to host)
    â†“ NTF_RULES_CHANGED (broadcast to all)
    â†“ NTF_PLAYER_LIST (broadcast updated ready states)
```

---

## ğŸ—ï¸ KIáº¾N TRÃšC THEO WORKFLOW.TXT

### **Backend Layer Separation:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Handler (room_handler.c)               â”‚
â”‚  - Validate session & permissions       â”‚
â”‚  - Validate business rules               â”‚
â”‚  - Call repo functions                   â”‚
â”‚  - Send response & broadcast             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Repo (room_repo.c)                     â”‚
â”‚  - room_repo_set_rules()                â”‚
â”‚  - Call db_patch()                       â”‚
â”‚  - Parse cJSON response                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DB Client (db_client.c)                â”‚
â”‚  - db_patch("rooms", ...)               â”‚
â”‚  - Execute PostgreSQL UPDATE             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Frontend Layer Separation:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Component (GameRulesPanel.js)          â”‚
â”‚  - UI rendering                          â”‚
â”‚  - Call service functions                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service (hostService.js)               â”‚
â”‚  - setRules(roomId, rules)              â”‚
â”‚  - Build payload                         â”‚
â”‚  - Call dispatcher                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Network (dispatcher.js)                â”‚
â”‚  - sendPacket(CMD_SET_RULE, payload)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ CHI TIáº¾T TRIá»‚N KHAI

### **BACKEND**

#### **File 1: [room_repo.h](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/include/db/repo/room_repo.h)** (NEW FUNCTION)
```c
// Add to Network/include/db/repo/room_repo.h

/**
 * Update room rules
 * @param room_id Room ID
 * @param mode 0=ELIMINATION, 1=SCORING
 * @param max_players 4-6
 * @param visibility 0=PUBLIC, 1=PRIVATE
 * @param wager_mode 0=OFF, 1=ON
 * @return 0 on success, -1 on error
 */
int room_repo_set_rules(
    uint32_t room_id,
    uint8_t mode,
    uint8_t max_players,
    uint8_t visibility,
    uint8_t wager_mode
);
```

#### **File 2: [room_repo.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/db/repo/room_repo.c)** (IMPLEMENTATION)
```c
// Add to Network/src/db/repo/room_repo.c

int room_repo_set_rules(
    uint32_t room_id,
    uint8_t mode,
    uint8_t max_players,
    uint8_t visibility,
    uint8_t wager_mode
) {
    // Build JSON payload
    cJSON *payload = cJSON_CreateObject();
    cJSON_AddStringToObject(payload, "mode", mode ? "scoring" : "elimination");
    cJSON_AddNumberToObject(payload, "max_players", max_players);
    cJSON_AddStringToObject(payload, "visibility", visibility ? "private" : "public");
    cJSON_AddBoolToObject(payload, "wager_mode", wager_mode);
    
    // Build filter
    char filter[64];
    snprintf(filter, sizeof(filter), "id = %u", room_id);
    
    // Call db_patch
    cJSON *response = NULL;
    db_error_t rc = db_patch("rooms", filter, payload, &response);
    
    cJSON_Delete(payload);
    if (response) cJSON_Delete(response);
    
    if (rc != DB_OK) {
        printf("[ROOM_REPO] Failed to update rules for room %u\n", room_id);
        return -1;
    }
    
    printf("[ROOM_REPO] Updated rules for room %u\n", room_id);
    return 0;
}
```

#### **File 3: [room_handler.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/room_handler.c)** (NEW HANDLER)
```c
// Add to Network/src/handlers/room_handler.c

void handle_set_rule(int client_fd, MessageHeader *req, const char *payload) {
    printf("[HANDLER] <SET_RULE> Request from fd=%d\n", client_fd);
    
    // STEP 1: Validate session
    UserSession *session = session_get_by_socket(client_fd);
    if (!session || session->state != SESSION_LOBBY) {
        send_error(client_fd, req, ERR_NOT_LOGGED_IN, "Not logged in or not in lobby");
        return;
    }
    
    // STEP 2: Parse payload
    if (req->length != 4) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Invalid payload size");
        return;
    }
    
    uint8_t mode = payload[0];
    uint8_t max_players = payload[1];
    uint8_t visibility = payload[2];
    uint8_t wager_mode = payload[3];
    
    printf("[HANDLER] <SET_RULE> mode=%u, max_players=%u, visibility=%u, wager=%u\n",
           mode, max_players, visibility, wager_mode);
    
    // STEP 3: Find room
    uint32_t room_id = room_find_by_player_account(session->account_id);
    if (room_id == 0) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Not in any room");
        return;
    }
    
    RoomState *room = room_get_state(room_id);
    if (!room) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Room not found");
        return;
    }
    
    // STEP 4: Validate permissions
    if (room->host_id != session->account_id) {
        send_error(client_fd, req, ERR_NOT_HOST, "Only host can change rules");
        return;
    }
    
    if (room->status != ROOM_WAITING) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Cannot change rules after game started");
        return;
    }
    
    // STEP 5: Validate rules
    if (mode == MODE_ELIMINATION && max_players != 4) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Elimination mode requires exactly 4 players");
        return;
    }
    
    if (mode == MODE_SCORING && (max_players < 4 || max_players > 6)) {
        send_error(client_fd, req, ERR_BAD_REQUEST, "Scoring mode requires 4-6 players");
        return;
    }
    
    // STEP 6: Update in-memory state
    room->mode = mode;
    room->max_players = max_players;
    room->visibility = visibility;
    room->wager_mode = wager_mode;
    
    // STEP 7: Reset all ready states
    for (int i = 0; i < room->player_count; i++) {
        room->players[i].is_ready = false;
    }
    
    printf("[HANDLER] <SET_RULE> Reset ready states for %d players\n", room->player_count);
    
    // STEP 8: Update database (via repo)
    int rc = room_repo_set_rules(room_id, mode, max_players, visibility, wager_mode);
    if (rc != 0) {
        printf("[HANDLER] <SET_RULE> Warning: Failed to sync rules to DB\n");
        // Continue anyway - eventual consistency
    }
    
    // STEP 9: Send response to host
    forward_response(client_fd, req, RES_RULES_UPDATED, "", 0);
    
    // STEP 10: Broadcast NTF_RULES_CHANGED
    cJSON *rules_json = cJSON_CreateObject();
    cJSON_AddStringToObject(rules_json, "mode", mode ? "scoring" : "elimination");
    cJSON_AddNumberToObject(rules_json, "maxPlayers", max_players);
    cJSON_AddStringToObject(rules_json, "visibility", visibility ? "private" : "public");
    cJSON_AddBoolToObject(rules_json, "wagerMode", wager_mode);
    
    char *rules_str = cJSON_PrintUnformatted(rules_json);
    room_broadcast(room_id, NTF_RULES_CHANGED, rules_str, strlen(rules_str), -1);
    free(rules_str);
    cJSON_Delete(rules_json);
    
    // STEP 11: Broadcast NTF_PLAYER_LIST (with updated ready states)
    broadcast_player_list(room_id);
    
    printf("[HANDLER] <SET_RULE> âœ… SUCCESS: room_id=%u\n", room_id);
}
```

#### **File 4: [dispatcher.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/dispatcher.c)** (REGISTER HANDLER)
```c
// Update Network/src/handlers/dispatcher.c

case CMD_SET_RULE:
    handle_set_rule(client_fd, header, payload);
    break;
```

---

### **FRONTEND**

#### **File 1: [hostService.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/services/hostService.js)** (NEW FUNCTION)
```javascript
// Add to Frontend/src/services/hostService.js

import { sendPacket } from '../network/dispatcher';
import { OPCODE } from '../network/opcode';

/**
 * Set game rules (host only)
 * @param {number} roomId - Room ID
 * @param {object} rules - { mode, maxPlayers, visibility, wagerMode }
 */
export function setRules(roomId, rules) {
    console.log('[HOST_SERVICE] setRules:', rules);
    
    // Build payload (4 bytes)
    const buffer = new ArrayBuffer(4);
    const view = new DataView(buffer);
    
    // Byte 0: mode (0=elimination, 1=scoring)
    view.setUint8(0, rules.mode === 'scoring' ? 1 : 0);
    
    // Byte 1: max_players
    view.setUint8(1, rules.maxPlayers || 4);
    
    // Byte 2: visibility (0=public, 1=private)
    view.setUint8(2, rules.visibility === 'private' ? 1 : 0);
    
    // Byte 3: wager_mode
    view.setUint8(3, rules.wagerMode ? 1 : 0);
    
    // Send packet
    sendPacket(OPCODE.CMD_SET_RULE, new Uint8Array(buffer));
}

// Register handler for RES_RULES_UPDATED
registerHandler(OPCODE.RES_RULES_UPDATED, (payload) => {
    console.log('[HOST_SERVICE] âœ… Rules updated successfully');
    // UI will be updated via NTF_RULES_CHANGED
});
```

#### **File 2: [WaitingRoom.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/WaitingRoom.js)** (HANDLE NOTIFICATION)
```javascript
// Update Frontend/src/components/Room/WaitingRoom/WaitingRoom.js

useEffect(() => {
    // ... existing handlers ...
    
    // Handle NTF_RULES_CHANGED
    const handleRulesChanged = (payload) => {
        console.log('[WaitingRoom] Rules changed notification');
        const data = JSON.parse(new TextDecoder().decode(payload));
        
        setRoom(prev => ({
            ...prev,
            gameRules: {
                mode: data.mode,
                maxPlayers: data.maxPlayers,
                visibility: data.visibility,
                wagerMode: data.wagerMode
            }
        }));
        
        // Show toast notification
        console.log('ğŸ”” Host changed game rules');
    };
    
    dispatcher.on(OPCODE.NTF_RULES_CHANGED, handleRulesChanged);
    
    return () => {
        dispatcher.off(OPCODE.NTF_RULES_CHANGED, handleRulesChanged);
    };
}, []);
```

#### **File 3: [GameRulesPanel.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/GameRulesPanel.js)** (UPDATE)
```javascript
// Update Frontend/src/components/Room/WaitingRoom/GameRulesPanel.js

// Change line 31 from immediate send to only send on "Done"
const handleDone = async () => {
    if (isHost) {
        try {
            await setRules(roomId, gameRules);
            console.log('âœ… Game rules committed');
            setEditMode(false);
        } catch (error) {
            console.error('âŒ Failed to commit rules:', error);
        }
    }
};

// Update button (line 69-74)
{isHost && (
    <button
        className="settings-icon-btn"
        onClick={editMode ? handleDone : () => setEditMode(true)}
    >
        {editMode ? "done" : "edit"}
    </button>
)}
```

---

## ğŸ§ª TEST CASES

### **TC-1: Host Thay Äá»•i Rules ThÃ nh CÃ´ng**
**Precondition:**
- User A (host) táº¡o room
- User B join vÃ o room
- Cáº£ 2 Ä‘á»u ready

**Steps:**
1. Host click "edit" trÃªn Game Rules Panel
2. Thay Ä‘á»•i mode tá»« "elimination" â†’ "scoring"
3. Thay Ä‘á»•i max_players tá»« 4 â†’ 6
4. Click "done"

**Expected:**
- âœ… Host nháº­n `RES_RULES_UPDATED`
- âœ… Cáº£ 2 players nháº­n `NTF_RULES_CHANGED`
- âœ… Cáº£ 2 players nháº­n `NTF_PLAYER_LIST` vá»›i `is_ready = false`
- âœ… UI cáº­p nháº­t rules má»›i
- âœ… Ready buttons reset vá» "Not Ready"

### **TC-2: Non-Host KhÃ´ng Thá»ƒ Thay Äá»•i**
**Steps:**
1. User B (khÃ´ng pháº£i host) cá»‘ gáº¯ng gá»­i `CMD_SET_RULE`

**Expected:**
- âœ… Server tráº£ vá» `ERR_NOT_HOST (406)`
- âœ… Rules khÃ´ng thay Ä‘á»•i

### **TC-3: Validation Rules**
**Steps:**
1. Host chá»n mode="elimination", max_players=6
2. Click "done"

**Expected:**
- âœ… Server tráº£ vá» `ERR_BAD_REQUEST (400)`
- âœ… Message: "Elimination mode requires exactly 4 players"

---

## ğŸ“Š VALIDATION RULES

| Mode | Max Players | Valid? |
|------|-------------|--------|
| Elimination | 4 | âœ… |
| Elimination | 5 | âŒ |
| Elimination | 6 | âŒ |
| Scoring | 3 | âŒ |
| Scoring | 4 | âœ… |
| Scoring | 5 | âœ… |
| Scoring | 6 | âœ… |
| Scoring | 7 | âŒ |

---

## ğŸš€ ROLLOUT PLAN

### **Phase 1: Backend (1-2 giá»)**
1. âœ… Add [room_repo_set_rules()](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/db/repo/room_repo.c#139-187) to [room_repo.h](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/include/db/repo/room_repo.h) & [room_repo.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/db/repo/room_repo.c)
2. âœ… Add [handle_set_rule()](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/room_handler.c#523-566) to [room_handler.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/room_handler.c)
3. âœ… Register handler in [dispatcher.c](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Network/src/handlers/dispatcher.c)
4. âœ… Test vá»›i Postman/curl

### **Phase 2: Frontend (1 giá»)**
1. âœ… Add `setRules()` to [hostService.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/services/hostService.js)
2. âœ… Update [GameRulesPanel.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/GameRulesPanel.js) - "Done" button logic
3. âœ… Add `NTF_RULES_CHANGED` handler to [WaitingRoom.js](file:///home/duyen/DAIHOC/NetworkProgramming/Final/the-price-is-right-multiplayer/Frontend/src/components/Room/WaitingRoom/WaitingRoom.js)

### **Phase 3: Testing (30 phÃºt)**
1. âœ… Test TC-1, TC-2, TC-3
2. âœ… Verify database sync
3. âœ… Verify broadcast to all players

---

## âš ï¸ EDGE CASES

### **1. Room Ä‘Ã£ báº¯t Ä‘áº§u game**
**Xá»­ lÃ½:** Reject vá»›i `ERR_BAD_REQUEST`
```c
if (room->status != ROOM_WAITING) {
    send_error(client_fd, req, ERR_BAD_REQUEST, 
               "Cannot change rules after game started");
    return;
}
```

### **2. Max players < current players**
**Scenario:** Host muá»‘n giáº£m max_players tá»« 6 â†’ 4, nhÆ°ng phÃ²ng Ä‘ang cÃ³ 5 ngÆ°á»i

**Xá»­ lÃ½:** Reject vá»›i message rÃµ rÃ ng
```c
// Add after STEP 5 in handle_set_rule()
if (max_players < room->player_count) {
    char error_msg[128];
    snprintf(error_msg, sizeof(error_msg),
             "Cannot set max players to %u. Room currently has %d players. "
             "Please kick players first or choose a higher limit.",
             max_players, room->player_count);
    send_error(client_fd, req, ERR_BAD_REQUEST, error_msg);
    return;
}
```

**Frontend:** Hiá»ƒn thá»‹ error message cho host

### **3. Reset Ready State (Design Decision)**
**Quyáº¿t Ä‘á»‹nh:** **LUÃ”N RESET** táº¥t cáº£ `is_ready = false` khi rules thay Ä‘á»•i

**LÃ½ do:**
- âœ… ÄÆ¡n giáº£n, dá»… implement
- âœ… An toÃ n: Players pháº£i confirm láº¡i vá»›i rules má»›i
- âœ… TrÃ¡nh confusion: Players biáº¿t rÃµ rules Ä‘Ã£ thay Ä‘á»•i
- âš ï¸ Trade-off: UX kÃ©m hÆ¡n má»™t chÃºt (pháº£i ready láº¡i)

**Implementation:**
```c
// STEP 7: Reset all ready states
for (int i = 0; i < room->player_count; i++) {
    room->players[i].is_ready = false;
}
```

**Scenario - Player disconnect sau khi reset:**
```
T=0s: Host Ä‘á»•i rules â†’ Server reset all is_ready = false
T=1s: Player B disconnect
T=2s: Player B reconnect â†’ Tháº¥y is_ready = false (Ä‘Ãºng)
```
âœ… **OK:** KhÃ´ng cÃ³ inconsistency vÃ¬ ready state Ä‘Ã£ Ä‘Æ°á»£c reset

### **4. Database sync fail**
**Xá»­ lÃ½:** Log warning, continue (eventual consistency)
```c
int rc = room_repo_set_rules(...);
if (rc != 0) {
    printf("[HANDLER] <SET_RULE> Warning: Failed to sync rules to DB\n");
    // Continue anyway - in-memory state is source of truth
}
```

---

## ğŸ“ NOTES

- âœ… TuÃ¢n thá»§ Workflow.txt: DB operations á»Ÿ repo layer
- âœ… Atomic update: Táº¥t cáº£ rules commit cÃ¹ng lÃºc
- âœ… Server authoritative: Client chá»‰ gá»­i request, server validate
- âœ… Broadcast pattern: Consistent vá»›i JOIN_ROOM use case
