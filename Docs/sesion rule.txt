1. Nguyên tắc chung (General Principles):
Định danh: Mỗi kết nối Socket (SocketID) sau khi xác thực sẽ được gắn với một UserID.
Độc quyền (Exclusivity): Tại một thời điểm, một UserID chỉ được phép có tối đa 1 Session hợp lệ để điều khiển game.
Ưu tiên trận đấu (Match Protection): Nếu người chơi đang trong trận, hệ thống ưu tiên bảo vệ phiên chơi đó khỏi sự can thiệp từ bên ngoài (đăng nhập đè).
2. Quy tắc Đăng nhập & Xử lý Trùng lặp (Concurrency Control):
Khi Server nhận được yêu cầu LOGIN(UserID) từ một Socket mới (NewSocket), hệ thống kiểm tra xem UserID này đã tồn tại trong danh sách Online chưa:
Trường hợp A: User chưa Online:
Hành động: Chấp nhận đăng nhập (ACCEPT).
Xử lý: Tạo Session mới, map UserID ↔ NewSocket. Chuyển trạng thái sang LOBBY.
Trường hợp B: User đang Online (Có OldSocket): Hệ thống kiểm tra Trạng thái (State) của OldSocket:
B1. Nếu OldSocket đang ở Sảnh (LOBBY/IDLE):
Hành động: Đá phiên cũ (KICK OLD).
Xử lý:
Gửi tin FORCE_LOGOUT tới OldSocket.
Đóng OldSocket.
Cập nhật map UserID ↔ NewSocket.
B2. Nếu OldSocket đang trong trận (PLAYING) và VẪN KẾT NỐI TỐT:
Hành động: Chặn phiên mới (BLOCK NEW).
Xử lý:
Gửi tin lỗi tới NewSocket: "Tài khoản đang trong trận đấu. Không thể đăng nhập lúc này."
Đóng NewSocket.
OldSocket tiếp tục chơi bình thường.
B3. Nếu OldSocket đang trong trận (PLAYING) nhưng MẤT KẾT NỐI (DISCONNECTED):
Hành động: Cho phép kết nối lại (RECONNECT).
Xử lý:
Hủy OldSocket.
Cập nhật map UserID ↔ NewSocket.
Thực hiện quy trình Đồng bộ trạng thái (State Sync) để người chơi tiếp tục ngay tại vòng chơi hiện tại.
3. Quy tắc Duy trì Kết nối (Heartbeat Policy)
Do sử dụng TCP/Socket, cần phát hiện kết nối chết ("zombies") để giải phóng tài nguyên.
Ping/Pong:
Client gửi PING mỗi 5 giây.
Server trả PONG để xác nhận.
Phát hiện mất kết nối (Detection):
Server lưu thời gian last_active của từng Socket.
Nếu current_time - last_active > 15 giây: Server đánh dấu Socket này là "Mất tín hiệu".
Xử lý khi mất tín hiệu:
Nếu đang ở Lobby: Xóa Session ngay lập tức.
Nếu đang Playing: Không xóa Session, chuyển trạng thái sang DISCONNECTED_GRACE (Chế độ chờ) và bắt đầu đếm ngược.

4. Quy tắc Tái đấu & Bỏ cuộc (Reconnect & Forfeit)
Áp dụng cho người chơi đang trong trạng thái DISCONNECTED_GRACE:
Thời gian chờ (Grace Period): 45 giây.
Thành công:
Nếu User đăng nhập lại trong vòng 45s (rơi vào Trường hợp B3 ở mục 2), Server gửi gói tin GAME_STATE chứa:
Round hiện tại, Câu hỏi hiện tại.
Điểm số hiện tại.
Thời gian còn lại của câu hỏi.
Thất bại (Timeout):
Sau 45s không thấy quay lại, Server xử lý FORFEIT:
Thông báo cho cả phòng: "Người chơi X đã bỏ cuộc."
Xóa User khỏi phòng và xóa Session khỏi bộ nhớ.
Trong chế độ Elimination: Coi như người chơi bị loại ở vòng này.
5. Máy trạng thái Session (Session State Machine)
Mỗi User Object trên Server C++ sẽ luôn nằm trong 1 trong 4 trạng thái sau:
UNAUTHENTICATED: Mới kết nối Socket, chưa gửi User/Pass. (Timeout: 10s → Kick).
LOBBY (IDLE): Đã đăng nhập, đang rảnh rỗi. (Luật: Cho phép Kick cũ lấy mới).
PLAYING (ACTIVE): Đang trong phòng game và kết nối ổn định. (Luật: Chặn đăng nhập mới).
PLAYING (DISCONNECTED): Đang trong phòng game nhưng mất tín hiệu. (Luật: Chờ Reconnect trong 45s).
6. Quy tắc Đăng xuất (Logout Policy):
Chủ động (User Logout): Client gửi LOGOUT -> Server xóa Session, đóng Socket.
Bị động (Server Kick): Server gửi gói tin KICK kèm lý do -> Đóng Socket.
Hết trận đấu: Khi game kết thúc, trạng thái người chơi chuyển từ PLAYING về LOBBY.
7.  Quy tắc Định dạng & Vệ sinh Dữ liệu (Input Sanitization)
Vì giao thức sử dụng ký tự xuống dòng \n để kết thúc tin nhắn, dữ liệu xác thực rất nhạy cảm với các ký tự đặc biệt.
Bộ ký tự cho phép (Allowlist):
Username: Chỉ chấp nhận chữ cái (a-z, A-Z), số (0-9) và dấu gạch dưới (_).
Cấm tuyệt đối: Ký tự khoảng trắng (space) và ký tự xuống dòng (\n, \r) trong Username/Password để tránh làm hỏng việc phân tách bản tin TCP.
Độ dài giới hạn:
Username: Tối thiểu 6 ký tự, tối đa 30 ký tự. Nếu vi phạm trả về 402 INVALID_USERNAME
Password: Tối thiểu 6 ký tự.
Gói tin tổng: Nếu tổng kích thước bản tin REG hoặc LOG vượt quá 4096 bytes, Server ngắt kết nối ngay lập tức để chống tấn công tràn bộ đệm (Buffer Overflow).
8. Quy tắc Bảo mật Mật khẩu (Password Security)
Hashing (Bắt buộc): Server không bao giờ lưu mật khẩu dưới dạng Plain Text (văn bản thuần) trong Database:
Quy trình Đăng ký (REG): Nhận password -> Hash (SHA256) -> Lưu chuỗi Hash vào DB.
Quy trình Đăng nhập (LOG): Nhận password từ Client -> Hash -> So sánh với chuỗi Hash trong DB.
Mã hóa đường truyền: Do giao thức là TCP text-based, mật khẩu gửi đi sẽ là clear-text. Nếu không dùng SSL/TLS, hãy coi đây là giới hạn của hệ thống (nhưng Server vẫn phải Hash trước khi lưu).

9. Quy tắc Chống Spam & Brute-force (Anti-Abuse)
Giới hạn thử sai (Login Attempts):
Trong trạng thái UNAUTHENTICATED, nếu một Socket gửi lệnh LOG sai mật khẩu 3 lần liên tiếp:
Hành động: Trả về 401 NOT_LOGGED_IN và ngay lập tức Đóng kết nối (Close Socket). Không cho phép thử lại trên cùng một kết nối để tránh Brute-force.
Timeout xác thực:
Thời gian sống của Socket ở trạng thái UNAUTHENTICATED là 10 giây. Đây là quy tắc hợp lý để dọn dẹp các kết nối "treo" (ghost connections) không chịu gửi lệnh đăng nhập.
10. Quy tắc Ràng buộc Trạng thái (State Enforcement)
Chỉ nhận lệnh LOG / REG khi UNAUTHENTICATED:
Nếu Socket đang ở trạng thái LOBBY hoặc PLAYING mà lại gửi lệnh LOG (đăng nhập user khác):
Hành động: Server từ chối xử lý, trả về lỗi 400 BAD_REQUEST vì sai ngữ cảnh (hoặc có thể coi là hành vi bất thường và đóng socket).
Xử lý Đăng ký trùng lặp:
Khi nhận lệnh REG, Server phải kiểm tra Username trong Database.
Nếu tồn tại: Trả về 400 BAD_REQUEST (hoặc mã lỗi tùy chỉnh cho User Exists) và giữ nguyên trạng thái UNAUTHENTICATED cho Socket đó (không đóng kết nối, cho phép khách nhập lại tên khác).



